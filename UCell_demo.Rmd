---
title: UCell demo
author: 
- Massimo Andreatta^[massimo.andreatta@unil.ch]
- Santiago Carmona^[santiago.carmona@unil.ch]
date: "15/02/2021"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
#output: html_notebook
---


```{r message=F, warning=F}
#renv::restore()
library(Seurat)
#Development moved to GitHub
remotes::install_github("carmonalab/UCell")

#system("R CMD build ../UCell")
#system("R CMD INSTALL UCell_0.2.1.tar.gz")

library(UCell)
library(AUCell)
```

#Object at: https://drive.switch.ch/index.php/s/3kM5PQ0tQaG6d6A
```{r}
pbmc.Tcell <- readRDS("data/pbmc_multimodal.downsampled20k.Tcell.seurat.RNA.rds")
DimPlot(object = pbmc.Tcell, reduction = "wnn.umap", group.by = "celltype.l2", label = TRUE, label.size = 3, repel = TRUE)
```
# Basic functionalities
```{r}
data.matrix <- pbmc.Tcell@assays$RNA@data

dim(data.matrix)
data.matrix[1:5,1:5]
```

Calculate on the fly
```{r}
set.seed(123)
basic.sign <- list( Tcell_signature = c("CD2","CD3E","CD3D"), Myeloid_signature = c("SPI1","FCER1G","CSF1R"))
scores <- ScoreSignatures_UCell(data.matrix,features=basic.sign)
scores[1:5,]
```

Show distribution of predicted scores
```{r}
library(reshape2)
melted <- melt(scores)
colnames(melted) <- c("Cell","Signature","Uscore")
p <- ggplot(melted, aes(x=Signature, y=Uscore)) + geom_violin(aes(fill=Signature), scale = "width") +
       geom_boxplot(width=0.1) + theme_bw()
p
```

Pre-compute ranks
```{r}
set.seed(123)
ranks <- StoreRankings_UCell(data.matrix)
ranks[1:5,1:5]
```

Now quickly evaluate signatures from pre-stored ranks
```{r}
set.seed(123)
scores.2 <- ScoreSignatures_UCell(data.matrix, features=basic.sign, precalc.ranks = ranks)

scores.2[1:5,]

plot(scores[,1], scores.2[,1])


new.sign <- list( CD4_Tcell = c("CD4","CD40LG"), CD8_Tcell = c("CD8A","CD8B"), Treg = c("FOXP3","IL2RA"))
scores.new <- ScoreSignatures_UCell(data.matrix, features=new.sign, precalc.ranks = ranks)

scores.new[1:5,]
melted <- melt(scores.new)
colnames(melted) <- c("Cell","Signature","Uscore")
p <- ggplot(melted, aes(x=Signature, y=Uscore)) + geom_violin(aes(fill=Signature), scale = "width") +
       geom_boxplot(width=0.1) + theme_bw()
p
```

Change seed and see effect on signature scores
```{r}
set.seed(999)
scores.3 <- ScoreSignatures_UCell(data.matrix,features=basic.sign)

plot(scores[,1], scores.3[,1])
plot(scores[,2], scores.3[,2])
```

Run in parallel with multiple cores
```{r}
scores <- ScoreSignatures_UCell(data.matrix, features=basic.sign, ncores=4)

melted <- melt(scores)
colnames(melted) <- c("Cell","Signature","Uscore")
p <- ggplot(melted, aes(x=Signature, y=Uscore)) + geom_violin(aes(fill=Signature), scale = "width") +
       geom_boxplot(width=0.1) + theme_bw()
p
```


# Easy interaction with Seurat

Define human T cell level 2 signatues
```{r, eval=T}
HCA.markers.Hs.Tcell <- list()
HCA.markers.Hs.Tcell$Tcell_CD4 <- c("CD4","CD40LG")
HCA.markers.Hs.Tcell$Tcell_CD8 <- c("CD8A","CD8B")
HCA.markers.Hs.Tcell$Tcell_Treg <- c("FOXP3","IL2RA")
HCA.markers.Hs.Tcell$Tcell_MAIT <- c("KLRB1", "SLC4A10", "NCR3")
HCA.markers.Hs.Tcell$Tcell_gd <- c("TRDC", "TRGC1", "TRGC2", "TRDV1")
HCA.markers.Hs.Tcell$Tcell_NK <- c("FGFBP2", "SPON2", "KLRF1", "FCGR3A", "KLRD1", "TRDC")
saveRDS(HCA.markers.Hs.Tcell,"data/HCA.markers.Hs.Tcell.PBMC.RData")
```



```{r}
Idents(pbmc.Tcell) <- "celltype.l1"
pbmc.Tcell.CD8 <- subset(pbmc.Tcell, idents = c("CD8 T"))
table(pbmc.Tcell.CD8@active.ident)
DimPlot(object = pbmc.Tcell.CD8, reduction = "wnn.umap", group.by = "celltype.l2", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()
```

AddModuleScore from Seurat is very fast, but the score is highly dependent on the composition of the dataset
```{r}
HCA.markers.Hs.Tcell <- readRDS("data/HCA.markers.Hs.Tcell.PBMC.RData")
pbmc.Tcell.CD8 <- AddModuleScore(pbmc.Tcell.CD8, features = list(Tcell_CD8=c("CD8A","CD8B")), name="Tcell_CD8_test", seed=123)
VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_test1")

pbmc.Tcell <- AddModuleScore(pbmc.Tcell, features = list(Tcell_CD8=c("CD8A","CD8B")), name="Tcell_CD8_test", seed=123)
VlnPlot(pbmc.Tcell, features = "Tcell_CD8_test1")

summary(pbmc.Tcell.CD8$Tcell_CD8_test1)
summary(subset(pbmc.Tcell, subset=celltype.l1=="CD8 T")$Tcell_CD8_test1)

```

UCell score is based on gene rankings and therefore is not affected by the composition of the query dataset
```{r}
gene.sets <- list(Tcell_CD8=c("CD8A","CD8B"))
pbmc.Tcell.CD8 <- AddModuleScore_UCell(pbmc.Tcell.CD8, features = gene.sets)
VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_UCell")

pbmc.Tcell <- AddModuleScore_UCell(pbmc.Tcell, features = gene.sets)
VlnPlot(pbmc.Tcell, features = "Tcell_CD8_UCell")

pbmc.Tcell <- AddModuleScore_UCell(pbmc.Tcell, features = gene.sets, ncores=4)
VlnPlot(pbmc.Tcell, features = "Tcell_CD8_UCell")
```

Evaluate more signatures for all flavors of T cells
```{r fig.height=3}
pbmc.Tcell.ss  <- AddModuleScore_UCell(pbmc.Tcell, features = HCA.markers.Hs.Tcell)
sign.names <- paste0(names(HCA.markers.Hs.Tcell),"_UCell")

VlnPlot(pbmc.Tcell.ss, features = sign.names)
VlnPlot(pbmc.Tcell.ss, features = sign.names, group.by = "celltype.l2")
```

How do signatures compare to original annotations
```{r fig.height=3}
Idents(pbmc.Tcell.ss) <- "celltype.l2"
DimPlot(object = pbmc.Tcell.ss, reduction = "wnn.umap", group.by = "celltype.l2", label.size = 3, repel = TRUE, label = T)
#DimPlot(object = pbmc.Tcell.ss, reduction = "wnn.umap", split.by = "celltype.l2", label.size = 3, repel = TRUE, ncol=4)
FeaturePlot(pbmc.Tcell.ss, reduction = "wnn.umap", features = sign.names, ncol=3, order=T)
```

Add non-existing genes
```{r}
pbmc.Tcell.CD8 <- AddModuleScore_UCell(pbmc.Tcell.CD8, features = list(Tcell_CD8=c("CD8A","CD8B","notagene")))
p1 <- VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_UCell")

pbmc.Tcell.CD8 <- AddModuleScore_UCell(pbmc.Tcell.CD8, features = list(Tcell_CD8=c("CD8A","CD8B","notagene","notagene2","notagene3")))
p2 <- VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_UCell")

pbmc.Tcell.CD8 <- AddModuleScore_UCell(pbmc.Tcell.CD8, features = list(Tcell_CD8=c("notagene","notagene2","notagene3")))
p3 <- VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_UCell")

p1 | p2 | p3

```

```{r}
pbmc.Tcell.CD8 <- AddModuleScore_UCell(pbmc.Tcell.CD8, features = list(Tcell_CD8=c("CD8A","CD8B")))
VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_UCell")


plot(pbmc.Tcell.CD8$Tcell_CD8_test1, pbmc.Tcell.CD8$Tcell_CD8_UCell)
plot(pbmc.Tcell$Tcell_CD8_test1, pbmc.Tcell$Tcell_CD8_UCell)

```


Compare to AUCell
```{r}
cells_rankings <- AUCell_buildRankings(pbmc.Tcell@assays$RNA@data,nCores = 1, plotStats = F)
cells_AUC <- AUCell_calcAUC(HCA.markers.Hs.Tcell, cells_rankings, aucMaxRank=1000)
cells_AUC.num <- as.data.frame(t(getAUC(cells_AUC)))
pbmc.Tcell <- AddMetaData(pbmc.Tcell,cells_AUC.num$Tcell_CD8,col.name = "Tcell_CD8_AUCell")
pbmc.Tcell <- AddMetaData(pbmc.Tcell,cells_AUC.num)
VlnPlot(pbmc.Tcell, features = "Tcell_CD8_AUCell")
VlnPlot(pbmc.Tcell, features = "Tcell_CD8")
```


```{r}
cells_rankings2 <- AUCell_buildRankings(pbmc.Tcell.CD8@assays$RNA@data,nCores = 1, plotStats = T)
cells_AUC2 <- AUCell_calcAUC(HCA.markers.Hs.Tcell, cells_rankings2, aucMaxRank=1000)
cells_AUC.num2 <- as.data.frame(t(getAUC(cells_AUC2)))
pbmc.Tcell.CD8 <- AddMetaData(pbmc.Tcell.CD8,cells_AUC.num2$Tcell_CD8,col.name = "Tcell_CD8_AUCell")
VlnPlot(pbmc.Tcell.CD8, features = "Tcell_CD8_AUCell")
```



```{r}
#Seurat ModuleScore vs UCell
plot(pbmc.Tcell.CD8$Tcell_CD8_test1, pbmc.Tcell.CD8$Tcell_CD8_UCell)

#AUCell vs UCell
plot(pbmc.Tcell.CD8$Tcell_CD8_AUCell, pbmc.Tcell.CD8$Tcell_CD8_UCell)
```



Test ranks storing functionality

```{r}
pbmc.Tcell.UcellPrecomp <- AddModuleScore_UCell(pbmc.Tcell, features = list(Tcell_CD8=c("CD8A","CD8B")), storeRanks = T)
VlnPlot(pbmc.Tcell.UcellPrecomp, features = "Tcell_CD8_UCell")

pbmc.Tcell.UcellPrecomp <- AddModuleScore_UCell(pbmc.Tcell, features = list(Tcell_CD8=c("CD8A","CD8B")), storeRanks = T, ncores = 8)
VlnPlot(pbmc.Tcell.UcellPrecomp, features = "Tcell_CD8_UCell")
```

#Check that scores calculate with rank pre-calculation are the same as those calculated "on the fly"
```{r}
pbmc.Tcell.UcellPrecomp <- AddModuleScore_UCell(pbmc.Tcell.UcellPrecomp, features = list(Tcell_CD8_copy=c("CD8A","CD8B")))
VlnPlot(pbmc.Tcell.UcellPrecomp, features = "Tcell_CD8_copy_UCell")

plot(pbmc.Tcell.UcellPrecomp$Tcell_CD8_UCell,pbmc.Tcell.UcellPrecomp$Tcell_CD8_copy_UCell)
```


```{r}
pbmc.Tcell.UcellPrecomp <- AddModuleScore_UCell(pbmc.Tcell.UcellPrecomp, features = HCA.markers.Hs.Tcell)
VlnPlot(pbmc.Tcell.UcellPrecomp, features = paste0(names(HCA.markers.Hs.Tcell),"_UCell"))

```

Gene ranks are stored here:
```{r}
head(pbmc.Tcell.UcellPrecomp@misc$UCell$RNA$cells_rankings[,1:10])
head(pbmc.Tcell.UcellPrecomp@misc$UCell$RNA$cells_rankings["CD8A",1:10])
hist(as.numeric(pbmc.Tcell.UcellPrecomp@misc$UCell$RNA$cells_rankings["CD8A",]))
```

Export small subset as sample data for the package
```{r}
Idents(pbmc.Tcell) <- "celltype.l1"
pbmc.ds <- subset(pbmc.Tcell, cells=WhichCells(pbmc.Tcell,downsample=200))
sample.matrix <- pbmc.ds@assays$RNA@data
save(sample.matrix, file="sample.matrix.RData")
```

