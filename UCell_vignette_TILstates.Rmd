---
title: Evaluating TIL subtype signatures using UCell
author: "M. Andreatta and S. Carmona"
date: "30/04/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'UCell_Seurat_vignette.html'))})
---

```{r setup, echo=FALSE, message=F, warning=F, results=F}
#install.packages("rmdformats")
#Template markdown setup
library(knitr)
library(rmdformats)
library(formatR)
library(renv)
renv::restore()

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               cache.lazy=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               dev='png')
opts_knit$set(width=75)

```

## Installation

```{r message=F, warning=F, results=F}
remotes::install_github("carmonalab/UCell")

library(Seurat)
library(UCell)
library(dplyr)
set.seed(123)
```

Use data from Yost et al. Nat Med 2019 https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6689255/
Pre-compiled R object available at https://drive.switch.ch/index.php/s/cluBLHkFFzLZWzL
```{r fig.height=2.5}
download.file("https://drive.switch.ch/index.php/s/cluBLHkFFzLZWzL","Yost.pretreatment.all.rds")
data.seurat <- readRDS("Yost.pretreatment.all.rds")
data.seurat <- data.seurat %>% NormalizeData %>% FindVariableFeatures %>% ScaleData %>% RunPCA %>% RunUMAP(dims=1:30)
data.seurat
```
Colour by patient and original cluster annotations
```{r}
DimPlot(data.seurat, group.by = "patient")
DimPlot(data.seurat, group.by = "cluster")
DimPlot(data.seurat, group.by = "cluster.T")
```


Unsupervised clustering
```{r}
set.seed(123)

which.red <- "pca"
resol=0.7
ndim=30

data.seurat <- FindNeighbors(data.seurat, reduction = which.red, dims = 1:ndim)
data.seurat <- FindClusters(data.seurat, resolution = resol)

DimPlot(data.seurat, reduction="umap", group.by = "seurat_clusters", label = T) + NoLegend()
```

Apply UCell with human cell type signatures to identify major cell types

These signatures were extracted from https://www.nature.com/articles/s41586-020-2157-4 and further filtered
```{r fig.height=3}

signaturesHumanCellTypes <- readRDS("aux/signaturesHumanCellTypes.rds")

head(signaturesHumanCellTypes)

data.seurat <- AddModuleScore_UCell(data.seurat, features=signaturesHumanCellTypes, ncores=4)

#Some major cell types to look at:
toplot <- c("Macrophage","Fibroblast","T.cell",
            "Stromal.cell","B.cell","Myeloid.cell",
            "Endothelial.cell.1","NK","Platelet")

featnames <- paste0(toplot,"_UCell")
FeaturePlot(data.seurat, features = featnames, pt.size=0.1, max.cutoff = 'q99')
VlnPlot(data.seurat, features = featnames, pt.size = 0, split.by = "seurat_clusters")
```

Identify T cell clusters by UCell score
```{r fig.height=3}
# select as Tcell clusters only those with median Uscore>0.2
medians <- sapply(levels(data.seurat$seurat_clusters), function(x){
   median(data.seurat@meta.data[data.seurat$seurat_clusters==x, "T.cell_UCell"])
})
tcell.clusters <- names(medians[medians>0.2])

#Add metadata
data.seurat$is.Tcell <- FALSE
data.seurat@meta.data[data.seurat$seurat_clusters %in% tcell.clusters, "is.Tcell"] <- TRUE
DimPlot(data.seurat, group.by = "is.Tcell")
```

Subset on T cells
```{r}
data.seurat.tcells <- subset(data.seurat, subset=is.Tcell==TRUE)
data.seurat.tcells
```

Recalculate embeddings and clustering
```{r}
ndim=20
data.seurat.tcells <- data.seurat.tcells %>% NormalizeData %>% FindVariableFeatures %>% ScaleData %>% RunPCA  %>% RunUMAP(dims=1:ndim)

data.seurat.tcells <- FindNeighbors(data.seurat.tcells, reduction = which.red, dims = 1:ndim)
data.seurat.tcells <- FindClusters(data.seurat.tcells, resolution = resol)

DimPlot(data.seurat.tcells, reduction="umap", group.by = "seurat_clusters", label = T) + NoLegend()
```

By patient and by annotation from original study
```{r}
DimPlot(data.seurat.tcells, group.by = "patient")
DimPlot(data.seurat.tcells, group.by = "cluster.T")

```


Apply UCell using T cell signatures from multi-study reference atlas
```{r fig.height=3}
#Signatures from TIL atlas, Andreatta et al  https://doi.org/10.1101/2020.06.23.166546

signaturesHumanTILs <- readRDS("aux/signaturesHumanTILs.rds")
signaturesHumanTILs[["cycling"]] <- c("TOP2A","MKI67","STMN1")

data.seurat.tcells <- AddModuleScore_UCell(data.seurat.tcells, features=signaturesHumanTILs, ncores=4)
```

```{r fig.height=4}
featnames <- paste0(names(sign.TIL),"_UCell")
FeaturePlot(data.seurat.tcells, features = featnames, pt.size=0.1)
VlnPlot(data.seurat.tcells, features = featnames, pt.size = 0, split.by = "seurat_clusters")
```

